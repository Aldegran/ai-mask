<!DOCTYPE html>
<html>
    <body style="background: #000; color: #fff; text-align: center; font-family: monospace;">
        <h1>Low Latency Preview</h1>
        <div style="display: flex; flex-direction: row; gap: 20px; padding: 20px; height: 90vh; align-items: flex-start;">
            
            <!-- LEFT COLUMN: Instruction -->
            <div style="flex: 1; display: flex; flex-direction: column; gap: 10px; text-align: left; height: 100%;">
                
                <textarea id="instructionArea" style="flex: 1; width: 100%; background: #0a0a0a; color: #ddd; border: 1px solid #333; padding: 15px; font-family: monospace; font-size: 14px; resize: none; border-radius: 5px;"></textarea>
                
                <button id="saveInstrBtn" style="padding: 15px; cursor: pointer; background: #222; color: #888; border: 1px solid #444; border-radius: 5px; font-weight: bold; transition: 0.2s;">SAVE INSTRUCTION TO SERVER</button>
            
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <textarea id="chatInput" placeholder="Type a message to Gemini..." style="flex: 1; min-height: 60px; background: #0a0a0a; color: #ddd; border: 1px solid #333; padding: 10px; resize: none; border-radius: 5px; font-family: monospace;"></textarea>
                    <button id="sendChatBtn" style="padding: 0 20px; cursor: pointer; background: #004400; color: #fff; border: none; border-radius: 4px; font-weight: bold;">SEND</button>
                    <button id="sendPingBtn" style="padding: 0 20px; cursor: pointer; background: #fdf902; color: #020202; border: none; border-radius: 4px; font-weight: bold;">PING</button>
                </div>
            </div>

            <!-- RIGHT COLUMN: Video & Controls -->
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 20px; height: 100%; overflow-y: auto;">
                
                <!-- Frame border controlled by JS via class/style -->
                <div id="videoContainer" style="position: relative; border: 5px solid #444; padding: 2px;">
                    <img id="videoStream" style="width: 320px; min-height: 240px; background: #222;" />
                    <div id="emotionDisplay" style="position: absolute; bottom: 10px; right: 10px; font-size: 32px; font-weight: bold; color: #fff; text-shadow: 0 0 5px #000, 0 0 10px #f00;"></div>
                </div>
                
                <div style="display: flex; gap: 20px; align-items: center; background: #111; padding: 15px; border-radius: 10px; border: 1px solid #333;">
                    <button id="startAudioBtn" style="padding: 10px 20px; font-size: 16px; cursor: pointer; background: #004400; color: #fff; border: none; border-radius: 4px;">START MONITOR</button>
                    
                    <label style="display: flex; align-items: center; gap: 10px; font-size: 18px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="useGeminiCk" style="width: 20px; height: 20px;">
                        USE GEMINI AI
                    </label>

                    <label style="display: flex; align-items: center; gap: 10px; font-size: 18px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="muteMicCk" style="width: 20px; height: 20px;">
                        MUTE MIC ECHO
                    </label>
                </div>

                <div id="status" style="color: #888; font-weight: bold;">System Status: Idle</div>

                <div style="width: 75%; text-align: left; flex: 1; display: flex; flex-direction: column;">
                    <label style="color: #aaa;">Gemini Response Log:</label>
                    <textarea id="geminiLog" readonly style="width: 100%; flex: 1; min-height: 150px; background: #000; color: #0f0; border: 1px solid #333; padding: 10px; font-family: monospace; font-size: 14px; margin-top: 5px; border-radius: 5px;"></textarea>
                </div>
            </div>

        </div>

        <script>
            const startBtn = document.getElementById('startAudioBtn');
            const useGeminiCk = document.getElementById('useGeminiCk');
            const muteMicCk = document.getElementById('muteMicCk');
            const statusDiv = document.getElementById('status');
            const videoImg = document.getElementById('videoStream');
            const videoContainer = document.getElementById('videoContainer');
            const geminiLog = document.getElementById('geminiLog');
            const instructionArea = document.getElementById('instructionArea');
            const saveInstrBtn = document.getElementById('saveInstrBtn');

            // --- INSTRUCTION MANAGER ---
            async function loadInstruction() {
                try {
                    const res = await fetch('/instruction');
                    const text = await res.text();
                    instructionArea.value = text;
                } catch(e) { console.error("Failed to load instruction", e); }
            }
            loadInstruction();

            saveInstrBtn.onclick = async () => {
                const text = instructionArea.value;
                try {
                    const res = await fetch('/instruction', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ text })
                    });
                    if (res.ok) {
                        console.log("Saved! Please toggle 'Use Gemini AI' off and on to apply changes.");
                    } else {
                        alert("Error saving.");
                    }
                } catch(e) { alert("Error: " + e.message); }
            };

            let audioCtx;
            let videoSocket;
            let audioSocket;
            let geminiControlSocket;
            let nextTime = 0;

            function log(msg) {
                geminiLog.value = `[${new Date().toLocaleTimeString()}] ${msg}\n` + geminiLog.value;
            }

            // --- GEMINI CONTROL ---
            const sendChatBtn = document.getElementById('sendChatBtn');
            const sendPingBtn = document.getElementById('sendPingBtn');

            function toggleGemini(enabled) {
                if (!geminiControlSocket || geminiControlSocket.readyState !== WebSocket.OPEN) return;
                
                geminiControlSocket.send(JSON.stringify({ 
                    type: 'gemini_control', 
                    enabled: enabled 
                }));

                if (enabled) {
                    videoContainer.style.borderColor = "#f00"; // Red Frame
                    log("Gemini Session REQUESTED...");
                } else {
                    videoContainer.style.borderColor = "#444"; // Grey Frame
                    log("Gemini Session ENDED.");
                }
            }

            useGeminiCk.addEventListener('change', (e) => {
                toggleGemini(e.target.checked);
            });

            // --- CHAT SEND ---
            sendChatBtn.onclick = () => {
                const text = document.getElementById('chatInput').value;
                if(!text) return;
                
                if (geminiControlSocket && geminiControlSocket.readyState === WebSocket.OPEN) {
                     log("User: " + text);
                     geminiControlSocket.send(JSON.stringify({
                         type: 'gemini_chat',
                         text: text
                     }));
                     document.getElementById('chatInput').value = '';
                } else {
                    log("Error: Control socket not connected. Start monitor first.");
                }
            };
            sendPingBtn.onclick = () => {
                if (geminiControlSocket && geminiControlSocket.readyState === WebSocket.OPEN) {
                     geminiControlSocket.send(JSON.stringify({
                         type: 'gemini_chat',
                         text: "[PING]"
                     }));
                } else {
                    log("Error: Control socket not connected. Start monitor first.");
                }
            };
            // -----------------

            // --- MONITOR SETUP ---
            function setupControlSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                geminiControlSocket = new WebSocket(protocol + '//' + window.location.host + '/control');
                
                geminiControlSocket.onopen = () => console.log("Control WS Connected");
                geminiControlSocket.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'gemini_response') {
                        log("AI: " + msg.text);
                    }
                    if (msg.type === 'gemini_whisper') {
                        log("WHISPER: " + msg.text);
                    }
                    if (msg.type === 'gemini_think') {
                        log("THINK: " + msg.text);
                    }
                    if (msg.type === 'gemini_emotion') {
                        //log("EMOTION: " + msg.emotion);
                        const emoDiv = document.getElementById('emotionDisplay');
                        const e = msg.emotion.toLowerCase();
                        let icon = '';
                        let color = '#fff';
                        
                        if (e.includes('joy') || e.includes('happ')) { icon = 'ðŸ˜Š'; color = '#0f0'; }
                        else if (e.includes('anger') || e.includes('angry')) { icon = 'ðŸ˜¡'; color = '#f00'; }
                        else if (e.includes('sad')) { icon = 'ðŸ˜¢'; color = '#00f'; }
                        else if (e.includes('surprise')) { icon = 'ðŸ˜²'; color = '#ff0'; }
                        else if (e.includes('fear')) { icon = 'ðŸ˜±'; color = '#f0f'; }
                        else if (e.includes('process')) { icon = 'ðŸ”„'; color = '#aaa'; }
                        
                        emoDiv.innerText = icon ? icon + " " + msg.emotion.toUpperCase() : '';
                        emoDiv.style.color = color;
                        
                        // Clear after 5 seconds
                        //setTimeout(() => { emoDiv.innerText = ''; }, 5000);
                    }
                    if (msg.type === 'log') {
                        // System logs from server
                        // log("SYS: " + msg.text); 
                    }
                };
            }

            startBtn.onclick = async () => {
                startBtn.disabled = true;
                startBtn.innerText = "Connecting...";
                
                try {
                    // 1. Audio Context
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000, 
                        latencyHint: 'interactive'
                    });
                    await audioCtx.resume();

                    // 2. Control Socket
                    setupControlSocket();

                    // 3. Video Monitor
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    videoSocket = new WebSocket(protocol + '//' + window.location.host + '/monitor/video');
                    videoSocket.binaryType = 'arraybuffer';
                    videoSocket.onmessage = (event) => {
                        const blob = new Blob([event.data], { type: 'image/jpeg' });
                        const url = URL.createObjectURL(blob);
                        videoImg.onload = () => URL.revokeObjectURL(url);
                        videoImg.src = url;
                    };

                    // 4. Audio Monitor (Expects Int16 now, need to fix playing)
                    // Since we switched server to s16le, we need to convert to float for AudioContext
                    audioSocket = new WebSocket(protocol + '//' + window.location.host + '/monitor/audio');
                    audioSocket.binaryType = 'arraybuffer';
                    
                    audioSocket.onmessage = (event) => {
                        if (muteMicCk.checked) return;

                        if (audioCtx.state === 'suspended') audioCtx.resume();
                        
                        const rawData = new Int16Array(event.data); 
                        const floatArray = new Float32Array(rawData.length);
                        for(let i=0; i<rawData.length; i++) floatArray[i] = rawData[i] / 32768.0;

                        const buffer = audioCtx.createBuffer(1, floatArray.length, 16000);
                        buffer.copyToChannel(floatArray, 0);
                        
                        const source = audioCtx.createBufferSource();
                        source.buffer = buffer;
                        source.connect(audioCtx.destination);
                        
                        if (nextTime < audioCtx.currentTime) nextTime = audioCtx.currentTime;
                        source.start(nextTime);
                        nextTime += buffer.duration;
                    };

                    // 5. TTS Monitor (Voice Response) - Mixes with Mic
                    const ttsSocket = new WebSocket(protocol + '//' + window.location.host + '/monitor/tts');
                    ttsSocket.binaryType = 'arraybuffer';
                    ttsSocket.onmessage = (event) => {
                        if (audioCtx.state === 'suspended') audioCtx.resume();
                        
                        // WAV file header is 44 bytes. Simple skip or decode?
                        // decodeAudioData is async and handles full WAV files perfectly.
                        // Since Piper sends full WAV files as blobs.
                        audioCtx.decodeAudioData(event.data, (buffer) => {
                            const source = audioCtx.createBufferSource();
                            source.buffer = buffer;
                            source.connect(audioCtx.destination);
                            source.start(0); // Play immediately mixed
                            //log("Playing TTS Audio...");
                        }, (err) => console.error("Error decoding TTS audio", err));
                    };

                    statusDiv.innerText = "System Active. Ready to use Gemini.";
                    statusDiv.style.color = "#0f0";
                    startBtn.style.display = 'none';

                } catch (err) {
                    console.error(err);
                    statusDiv.innerText = "Error: " + err.message;
                    startBtn.disabled = false;
                }
            };
        </script>
    </body>
</html>